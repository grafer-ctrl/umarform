<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input Radiologi Modern</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488', // Teal 600
                        secondary: '#0f766e', // Teal 700
                        accent: '#f0fdfa', // Teal 50
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- Navbar -->
    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-hospital-user mr-2"></i>E-Radiologi Recorder</h1>
            <div>
                <button onclick="downloadExcel()" class="bg-white text-primary px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition shadow text-sm">
                    <i class="fa-solid fa-file-excel mr-1"></i> Unduh Data
                </button>
                <button onclick="deleteAllData()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition shadow ml-2 text-sm">
                    <i class="fa-solid fa-trash mr-1"></i> Reset
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Form Section -->
        <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-10 border border-gray-200">
            <div class="bg-accent px-6 py-4 border-b border-teal-100">
                <h2 class="text-xl font-bold text-secondary">Form Input Pemeriksaan</h2>
                <p class="text-sm text-gray-500">Isi data pasien dengan lengkap.</p>
            </div>
            
            <form id="radiologyForm" class="p-6">
                <!-- Hidden ID for Editing -->
                <input type="hidden" id="dataId">

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Basic Info -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">No (Manual)</label>
                        <input type="text" id="noManual" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" placeholder="Masukkan Nomor">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Penjamin*</label>
                        <select id="kodePenjamin" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="">Pilih Kode</option>
                            <option value="ROBPJS">ROBPJS</option>
                            <option value="ROUMUM">ROUMUM</option>
                            <option value="USGBPJS">USGBPJS</option>
                            <option value="USGUMUM">USGUMUM</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tgl Pemeriksaan*</label>
                        <input type="date" id="tglPemeriksaan" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pasien*</label>
                        <input type="text" id="namaPasien" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" placeholder="Nama Lengkap" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin*</label>
                        <select id="jenisKelamin" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas*</label>
                        <select id="kelas" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="ASYYIFA">ASYYIFA</option>
                            <option value="MULTAZAM">MULTAZAM</option>
                            <option value="SALSABILA">SALSABILA</option>
                            <option value="FIRDAUS">FIRDAUS</option>
                            <option value="POLI UMUM">POLI UMUM</option>
                            <option value="LUAR RS">LUAR RS</option>
                            <option value="UGD">UGD</option>
                            <option value="POLI DALAM">POLI DALAM</option>
                            <option value="POLI ANAK">POLI ANAK</option>
                            <option value="RUJUKAN LUAR">RUJUKAN LUAR</option>
                        </select>
                    </div>

                    <!-- Doctor Info -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Dokter*</label>
                        <select id="jenisDokter" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="UMUM">UMUM</option>
                            <option value="SPESIALIS">SPESIALIS</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dokter Pengirim*</label>
                        <select id="dokterPengirim" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="">Pilih Dokter</option>
                            <option value="dr. Rini Nurul Hidayah">dr. Rini Nurul Hidayah</option>
                            <option value="dr. Dadang Ismanaf">dr. Dadang Ismanaf</option>
                            <option value="dr. Misbakhul Munir">dr. Misbakhul Munir</option>
                            <option value="dr. Rhama Patria Bharata, M.Med.Sc.,Sp.A">dr. Rhama Patria Bharata, M.Med.Sc.,Sp.A</option>
                            <option value="dr. Kurbiyanto">dr. Kurbiyanto</option>
                            <option value="dr. Rakhma Nur Aziza">dr. Rakhma Nur Aziza</option>
                            <option value="dr. Herry Purwanto">dr. Herry Purwanto</option>
                            <option value="dr. Khoirul Anwar, Sp.PD">dr. Khoirul Anwar, Sp.PD</option>
                            <option value="dr. Yudha Irla Saputra, Sp.PD, M.M.R">dr. Yudha Irla Saputra, Sp.PD, M.M.R</option>
                        </select>
                    </div>

                    <!-- Technical Info -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Film*</label>
                        <input type="number" id="jumlahFilm" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pengulangan Foto*</label>
                        <select id="pengulanganFoto" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Faktor Eksposi (Manual)*</label>
                        <input type="text" id="faktorEksposi" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Radiografer*</label>
                        <select id="radiografer" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="Umar Said">Umar Said</option>
                            <option value="Wafiq Farida Az Zahraa">Wafiq Farida Az Zahraa</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jasa Radiografer</label>
                        <select id="jasaRadiografer" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2">
                            <option value="-">-</option>
                            <option value="5000">5000</option>
                            <option value="6000">6000</option>
                            <option value="7000">7000</option>
                            <option value="8000">8000</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jasa Bahaya Radiasi</label>
                        <select id="jasaBahaya" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2">
                      
                            <option value="-">-</option>
                            <option value="3500">3500</option>
                            <option value="4200">4200</option>
                            <option value="5000">5000</option>
                            <option value="6000">6000</option>
                        </select>
                    </div>

                    <!-- Dynamic Examination Section -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 border-t-2 border-dashed border-gray-200 my-4 pt-4">
                        <h3 class="text-lg font-bold text-secondary mb-4">Rincian Pemeriksaan & Tarif</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pemeriksaan*</label>
                                <select id="jenisPemeriksaan" onchange="updateTarifFields()" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2 bg-teal-50" required>
                                    <option value="">-- Pilih Pemeriksaan --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>

                            <!-- Dynamic Field Container -->
                            <div id="tarifContainer">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tarif Pemeriksaan</label>
                                <select disabled class="w-full bg-gray-100 border p-2 rounded"><option>Pilih jenis pemeriksaan dulu</option></select>
                            </div>

                            <div id="jasaDokterContainer">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jasa Dokter</label>
                                <select disabled class="w-full bg-gray-100 border p-2 rounded"><option>Pilih jenis pemeriksaan dulu</option></select>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-8 flex justify-end gap-3">
                     <button type="button" onclick="clearForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">Batal</button>
                    <button type="submit" class="bg-primary text-white px-8 py-2 rounded-lg font-bold hover:bg-secondary transition transform hover:-translate-y-1 shadow-md">
                        <i class="fa-solid fa-save mr-2"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>

        <!-- Data Table Section -->
        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-700">Data Tersimpan</h2>
                <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari Nama Pasien..." class="border rounded px-3 py-1 text-sm">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-3">Tgl</th>
                            <th class="px-4 py-3">No</th>
                            <th class="px-4 py-3">Pasien</th>
                            <th class="px-4 py-3">Dokter Pengirim</th>
                            <th class="px-4 py-3">Pemeriksaan</th>
                            <th class="px-4 py-3">Tarif</th>
                            <th class="px-4 py-3">Jasa Dokter</th>
                            <th class="px-4 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Rows rendered by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer class="text-center text-gray-400 text-xs mt-8 pb-4">
            &copy; 2025 Radiology Data System. Local Storage Enabled.
        </footer>

    </div>

    <!-- JavaScript Logic -->
     <!-- MULAI SCRIPT LENGKAP -->
    <script>
        // ==========================================
        // 1. KONFIGURASI SUPABASE
        // ==========================================
        const SUPABASE_URL = 'https://vguygxecyogjervhmpmo.supabase.co';
        
        // --- MASUKKAN KODE KUNCI PANJANG ANDA DI ANTARA TANDA KUTIP DI BAWAH INI ---
        const SUPABASE_KEY = 'PASTE_KODE_SUPABASE_ANON_KEY_ANDA_DISINI'; 
        
        // Inisialisasi Client Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ==========================================
        // 2. DATA CONFIGURATION (HARGA & MENU)
        // ==========================================
        const pricingConfig = {
            "THORAX": { tarif: [122500, 130500, 145500, 153500], jasa: [40000, 46000, 54000, 58000] },
            "LUMBAL": { tarif: [190500, 195500, 202500, 209500], jasa: [66000, 70000, 74000, 76000] },
            "ABDOMEN 3 PSS": { tarif: [302500, 326500, 366000, 388500], jasa: [124000, 138000, 160000, 174000] },
            "KEPALA": { tarif: [150000, 216000, 259200, 311040], jasa: [36000, 39000, 41000, 43000] },
            "CERVICAL": { tarif: [167000, 190500, 205000, 217500], jasa: [66000, 80000, 88000, 96000] },
            "CLAVICULA": { tarif: [104000, 116500, 124000, 131000], jasa: [33000, 40000, 44000, 48000] },
            "SHOULDER": { tarif: [147500, 154500, 162500, 171500], jasa: [52000, 55000, 60000, 64000] },
            "HUMERUS": { tarif: [147500, 154500, 162500, 171500], jasa: [52000, 55000, 60000, 64000] },
            "ANTEBRACHI": { tarif: [147500, 154500, 162500, 171500], jasa: [52000, 55000, 60000, 64000] },
            "ELBOW": { tarif: [147500, 154500, 162500, 171500], jasa: [52000, 55000, 60000, 64000] },
            "MANUS": { tarif: [158500, 165500, 173500, 182500], jasa: [52000, 55000, 60000, 64000] },
            "WRIST": { tarif: [158500, 165500, 173500, 182500], jasa: [5000, 6000, 7000, 8000], jasaLabel: "Jasa Radiografer Wrist" },
            "THORACHOLUMBAL": { tarif: [228000, 273600, 328320, 393984], jasa: [78796, 65664, 54720, 45600] },
            "THORACHAL": { tarif: [190500, 195500, 202500, 209500], jasa: [66000, 70000, 74000, 76000] },
            "PEDIS": { tarif: [149500, 154500, 162500, 171500], jasa: [50000, 55000, 60000, 64000] },
            "ANKLE": { tarif: [149500, 154500, 162500, 171500], jasa: [50000, 55000, 60000, 64000] },
            "GENU": { tarif: [149500, 154500, 162500, 171500], jasa: [50000, 55000, 60000, 64000] },
            "CRURIS": { tarif: [172500, 179500, 186500, 193500], jasa: [66000, 70000, 73000, 76000] },
            "FEMUR": { tarif: [172500, 179500, 186500, 193500], jasa: [66000, 70000, 73000, 76000] },
            "USG ABDOMEN": { tarif: [400000, 440000, 480000, 520000], jasa: "manual" },
            "USG TIROID": { tarif: [175000, 192000, 21000, 227500], jasa: "manual" },
            "USG MAMAE": { tarif: [190000, 209000, 219000, 228000], jasa: "manual" },
            "USG DOPLER EXTREMITAS": { tarif: [220000, 242000, 264000, 286000], jasa: "manual" },
            "USG LAIN LAIN": { tarif: "manual", jasa: "manual" },
            "BNO": { tarif: "manual", jasa: "manual" }, 
            "ABDOMEN": { tarif: "manual", jasa: "manual" },
            "PELVIS": { tarif: "manual", jasa: "manual" }
        };

        // ==========================================
        // 3. LOGIKA APLIKASI UTAMA
        // ==========================================

        let globalData = [];

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tglPemeriksaan').valueAsDate = new Date();
            populateJenisPemeriksaan();
            fetchData();
        });

        function populateJenisPemeriksaan() {
            const select = document.getElementById('jenisPemeriksaan');
            // Bersihkan dulu
            select.innerHTML = '<option value="">-- Pilih --</option>';
            
            Object.keys(pricingConfig).sort().forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                select.appendChild(opt);
            });
        }

        function updateTarifFields() {
            const jenis = document.getElementById('jenisPemeriksaan').value;
            const tarifContainer = document.getElementById('tarifContainer');
            const jasaContainer = document.getElementById('jasaDokterContainer');

            if (!jenis || !pricingConfig[jenis]) return;
            const config = pricingConfig[jenis];

            // Build Tarif
            let tarifHtml = `<label class="block text-sm font-medium text-gray-700 mb-1">Tarif Pemeriksaan</label>`;
            if (config.tarif === "manual") {
                tarifHtml += `<input type="number" id="tarifPemeriksaan" class="input-field w-full border p-2 rounded" placeholder="Input Rp">`;
            } else {
                tarifHtml += `<select id="tarifPemeriksaan" class="input-field w-full border p-2 rounded">`;
                config.tarif.forEach(val => tarifHtml += `<option value="${val}">Rp ${val.toLocaleString('id-ID')}</option>`);
                tarifHtml += `</select>`;
            }
            tarifContainer.innerHTML = tarifHtml;

            // Build Jasa
            let jasaLabel = config.jasaLabel || "Jasa Dokter";
            let jasaHtml = `<label class="block text-sm font-medium text-gray-700 mb-1">${jasaLabel}</label>`;
            if (config.jasa === "manual") {
                jasaHtml += `<input type="number" id="jasaDokter" class="input-field w-full border p-2 rounded" placeholder="Input Rp">`;
            } else {
                jasaHtml += `<select id="jasaDokter" class="input-field w-full border p-2 rounded">`;
                config.jasa.forEach(val => jasaHtml += `<option value="${val}">Rp ${val.toLocaleString('id-ID')}</option>`);
                jasaHtml += `</select>`;
            }
            jasaContainer.innerHTML = jasaHtml;
        }

        // --- Database Operations ---

        async function fetchData() {
            if(SUPABASE_KEY.includes("PASTE_KODE")) {
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-red-500 py-4 font-bold">SILAKAN EDIT SCRIPT DAN MASUKKAN SUPABASE KEY ANDA!</td></tr>';
                return;
            }

            const { data, error } = await supabase
                .from('radiology_records')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                // Jangan alert error saat loading awal agar tidak mengganggu jika data kosong
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="7" class="text-center py-4">Belum ada data</td></tr>';
            } else {
                globalData = data;
                renderTable();
            }
        }

        document.getElementById('radiologyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;

            const id = document.getElementById('dataId').value;
            
            // Collect Data
            const formData = {
                no_manual: document.getElementById('noManual').value,
                kode_penjamin: document.getElementById('kodePenjamin').value,
                tgl_pemeriksaan: document.getElementById('tglPemeriksaan').value,
                nama_pasien: document.getElementById('namaPasien').value,
                jenis_kelamin: document.getElementById('jenisKelamin').value,
                kelas: document.getElementById('kelas').value,
                jenis_dokter: document.getElementById('jenisDokter').value,
                dokter_pengirim: document.getElementById('dokterPengirim').value,
                jumlah_film: document.getElementById('jumlahFilm').value,
                pengulangan_foto: document.getElementById('pengulanganFoto').value,
                faktor_eksposi: document.getElementById('faktorEksposi').value,
                radiografer: document.getElementById('radiografer').value,
                jasa_radiografer: document.getElementById('jasaRadiografer').value,
                jasa_bahaya: document.getElementById('jasaBahaya').value,
                jenis_pemeriksaan: document.getElementById('jenisPemeriksaan').value,
                tarif_pemeriksaan: document.getElementById('tarifPemeriksaan').value,
                jasa_dokter: document.getElementById('jasaDokter').value
            };

            let error;
            if (id) {
                // UPDATE
                const { error: err } = await supabase.from('radiology_records').update(formData).eq('id', id);
                error = err;
            } else {
                // INSERT
                const { error: err } = await supabase.from('radiology_records').insert([formData]);
                error = err;
            }

            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up mr-2"></i> Simpan';
            btn.disabled = false;

            if (error) {
                alert("Gagal menyimpan: " + error.message);
            } else {
                alert("Berhasil!");
                resetForm();
                fetchData();
            }
        });

        async function deleteItem(id) {
            if(confirm("Hapus data ini?")) {
                const { error } = await supabase.from('radiology_records').delete().eq('id', id);
                if (!error) fetchData();
            }
        }

        async function deleteAllData() {
            const pwd = prompt("Masukkan Password untuk MENGHAPUS SEMUA DATA:");
            if(pwd !== "123456") { alert("Password Salah!"); return; }
            if(!confirm("PERINGATAN: Data akan hilang permanen!")) return;

            const { error } = await supabase.from('radiology_records').delete().neq('id', 0);
            
            if (error) alert("Gagal menghapus: " + error.message);
            else {
                alert("Semua data terhapus.");
                fetchData();
            }
        }

        function editItem(id) {
            const item = globalData.find(i => i.id == id);
            if(!item) return;

            document.getElementById('dataId').value = item.id;
            document.getElementById('noManual').value = item.no_manual;
            document.getElementById('kodePenjamin').value = item.kode_penjamin;
            document.getElementById('tglPemeriksaan').value = item.tgl_pemeriksaan;
            document.getElementById('namaPasien').value = item.nama_pasien;
            document.getElementById('jenisKelamin').value = item.jenis_kelamin;
            document.getElementById('kelas').value = item.kelas;
            document.getElementById('jenisDokter').value = item.jenis_dokter;
            document.getElementById('dokterPengirim').value = item.dokter_pengirim;
            document.getElementById('jumlahFilm').value = item.jumlah_film;
            document.getElementById('pengulanganFoto').value = item.pengulangan_foto;
            document.getElementById('faktorEksposi').value = item.faktor_eksposi;
            document.getElementById('radiografer').value = item.radiografer;
            document.getElementById('jasaRadiografer').value = item.jasa_radiografer;
            document.getElementById('jasaBahaya').value = item.jasa_bahaya;
            
            // Trigger dynamic fields
            document.getElementById('jenisPemeriksaan').value = item.jenis_pemeriksaan;
            updateTarifFields();
            
            setTimeout(() => {
                if(document.getElementById('tarifPemeriksaan')) document.getElementById('tarifPemeriksaan').value = item.tarif_pemeriksaan;
                if(document.getElementById('jasaDokter')) document.getElementById('jasaDokter').value = item.jasa_dokter;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        function renderTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            const filtered = globalData.filter(i => i.nama_pasien.toLowerCase().includes(term));

            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Tidak ada data</td></tr>';
                return;
            }

            filtered.forEach(item => {
                const tarif = item.tarif_pemeriksaan ? parseInt(item.tarif_pemeriksaan).toLocaleString('id-ID') : '0';
                const jasa = item.jasa_dokter ? parseInt(item.jasa_dokter).toLocaleString('id-ID') : '0';
                
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-4 py-3">${item.tgl_pemeriksaan}</td>
                    <td class="px-4 py-3">${item.no_manual}</td>
                    <td class="px-4 py-3 font-medium">${item.nama_pasien}</td>
                    <td class="px-4 py-3 text-green-600">${item.jenis_pemeriksaan}</td>
                    <td class="px-4 py-3">Rp${tarif}</td>
                    <td class="px-4 py-3">Rp${jasa}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editItem(${item.id})" class="text-blue-500 mx-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteItem(${item.id})" class="text-red-500 mx-1"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function resetForm() {
            document.getElementById('radiologyForm').reset();
            document.getElementById('dataId').value = '';
            document.getElementById('tglPemeriksaan').valueAsDate = new Date();
            updateTarifFields();
        }

        function downloadExcel() {
            if(globalData.length === 0) { alert("Data kosong"); return; }
            
            const header = ["ID", "Tgl", "No Manual", "Pasien", "Kode", "JK", "Kelas", "Dokter", "Pengirim", "Jml Film", "Pengulangan", "Faktor", "Radiografer", "Jasa Rad", "Jasa Bahaya", "Pemeriksaan", "Tarif", "Jasa Dr"];
            
            const rows = globalData.map(d => [
                d.id, d.tgl_pemeriksaan, `"${d.no_manual}"`, `"${d.nama_pasien}"`, d.kode_penjamin, d.jenis_kelamin, d.kelas, d.jenis_dokter, `"${d.dokter_pengirim}"`, d.jumlah_film, d.pengulangan_foto, `"${d.faktor_eksposi}"`, d.radiografer, d.jasa_radiografer, d.jasa_bahaya, `"${d.jenis_pemeriksaan}"`, d.tarif_pemeriksaan, d.jasa_dokter
            ]);

            let csvContent = "data:text/csv;charset=utf-8," + header.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "data_radiologi_supabase.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
