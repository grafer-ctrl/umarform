<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input Radiologi Modern</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488', // Teal 600
                        secondary: '#0f766e', // Teal 700
                        accent: '#f0fdfa', // Teal 50
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- Navbar -->
    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-hospital-user mr-2"></i>E-Radiologi Recorder</h1>
            <div>
                <button onclick="downloadExcel()" class="bg-white text-primary px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition shadow text-sm">
                    <i class="fa-solid fa-file-excel mr-1"></i> Unduh Data
                </button>
                <button onclick="deleteAllData()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition shadow ml-2 text-sm">
                    <i class="fa-solid fa-trash mr-1"></i> Reset
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Form Section -->
        <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-10 border border-gray-200">
            <div class="bg-accent px-6 py-4 border-b border-teal-100">
                <h2 class="text-xl font-bold text-secondary">Form Input Pemeriksaan</h2>
                <p class="text-sm text-gray-500">Isi data pasien dengan lengkap.</p>
            </div>
            
            <form id="radiologyForm" class="p-6">
                <!-- Hidden ID for Editing -->
                <input type="hidden" id="dataId">

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Basic Info -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">No (Manual)</label>
                        <input type="text" id="noManual" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" placeholder="Masukkan Nomor">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Penjamin*</label>
                        <select id="kodePenjamin" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="">Pilih Kode</option>
                            <option value="ROBPJS">ROBPJS</option>
                            <option value="ROUMUM">ROUMUM</option>
                            <option value="USGBPJS">USGBPJS</option>
                            <option value="USGUMUM">USGUMUM</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tgl Pemeriksaan*</label>
                        <input type="date" id="tglPemeriksaan" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pasien*</label>
                        <input type="text" id="namaPasien" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" placeholder="Nama Lengkap" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin*</label>
                        <select id="jenisKelamin" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelas*</label>
                        <select id="kelas" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="ASYYIFA">ASYYIFA</option>
                            <option value="MULTAZAM">MULTAZAM</option>
                            <option value="SALSABILA">SALSABILA</option>
                            <option value="FIRDAUS">FIRDAUS</option>
                            <option value="POLI UMUM">POLI UMUM</option>
                            <option value="LUAR RS">LUAR RS</option>
                            <option value="UGD">UGD</option>
                            <option value="POLI DALAM">POLI DALAM</option>
                            <option value="POLI ANAK">POLI ANAK</option>
                            <option value="RUJUKAN LUAR">RUJUKAN LUAR</option>
                        </select>
                    </div>

                    <!-- Doctor Info -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Dokter*</label>
                        <select id="jenisDokter" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="UMUM">UMUM</option>
                            <option value="SPESIALIS">SPESIALIS</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dokter Pengirim*</label>
                        <select id="dokterPengirim" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="">Pilih Dokter</option>
                            <option value="dr. Rini Nurul Hidayah">dr. Rini Nurul Hidayah</option>
                            <option value="dr. Dadang Ismanaf">dr. Dadang Ismanaf</option>
                            <option value="dr. Misbakhul Munir">dr. Misbakhul Munir</option>
                            <option value="dr. Rhama Patria Bharata, M.Med.Sc.,Sp.A">dr. Rhama Patria Bharata, M.Med.Sc.,Sp.A</option>
                            <option value="dr. Kurbiyanto">dr. Kurbiyanto</option>
                            <option value="dr. Rakhma Nur Aziza">dr. Rakhma Nur Aziza</option>
                            <option value="dr. Herry Purwanto">dr. Herry Purwanto</option>
                            <option value="dr. Khoirul Anwar, Sp.PD">dr. Khoirul Anwar, Sp.PD</option>
                            <option value="dr. Yudha Irla Saputra, Sp.PD, M.M.R">dr. Yudha Irla Saputra, Sp.PD, M.M.R</option>
                        </select>
                    </div>

                    <!-- Technical Info -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Film*</label>
                        <input type="number" id="jumlahFilm" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pengulangan Foto*</label>
                        <select id="pengulanganFoto" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Faktor Eksposi (Manual)*</label>
                        <input type="text" id="faktorEksposi" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Radiografer*</label>
                        <select id="radiografer" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2" required>
                            <option value="Umar Said">Umar Said</option>
                            <option value="Wafiq Farida Az Zahraa">Wafiq Farida Az Zahraa</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jasa Radiografer</label>
                        <select id="jasaRadiografer" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2">
                            <option value="-">-</option>
                            <option value="5000">5000</option>
                            <option value="6000">6000</option>
                            <option value="7000">7000</option>
                            <option value="8000">8000</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jasa Bahaya Radiasi</label>
                        <select id="jasaBahaya" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2">
                           // ==========================================
// 1. KONFIGURASI SUPABASE (SUDAH SAYA ISI SESUAI GAMBAR)
// ==========================================
const SUPABASE_URL = 'https://vguygxecyogjervhmpmo.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZndXlneGVjeW9namVydmhtcG1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMzM0NzIsImV4cCI6MjA3OTcwOTQ3Mn0.1gCVbR0Xwi8O_UrDCh5qbd52uQurv_F4SXDRGZw1RiI';
                            
                            <option value="-">-</option>
                            <option value="3500">3500</option>
                            <option value="4200">4200</option>
                            <option value="5000">5000</option>
                            <option value="6000">6000</option>
                        </select>
                    </div>

                    <!-- Dynamic Examination Section -->
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 border-t-2 border-dashed border-gray-200 my-4 pt-4">
                        <h3 class="text-lg font-bold text-secondary mb-4">Rincian Pemeriksaan & Tarif</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pemeriksaan*</label>
                                <select id="jenisPemeriksaan" onchange="updateTarifFields()" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary border p-2 bg-teal-50" required>
                                    <option value="">-- Pilih Pemeriksaan --</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </div>

                            <!-- Dynamic Field Container -->
                            <div id="tarifContainer">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tarif Pemeriksaan</label>
                                <select disabled class="w-full bg-gray-100 border p-2 rounded"><option>Pilih jenis pemeriksaan dulu</option></select>
                            </div>

                            <div id="jasaDokterContainer">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jasa Dokter</label>
                                <select disabled class="w-full bg-gray-100 border p-2 rounded"><option>Pilih jenis pemeriksaan dulu</option></select>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="mt-8 flex justify-end gap-3">
                     <button type="button" onclick="clearForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition">Batal</button>
                    <button type="submit" class="bg-primary text-white px-8 py-2 rounded-lg font-bold hover:bg-secondary transition transform hover:-translate-y-1 shadow-md">
                        <i class="fa-solid fa-save mr-2"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>

        <!-- Data Table Section -->
        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-700">Data Tersimpan</h2>
                <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari Nama Pasien..." class="border rounded px-3 py-1 text-sm">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-3">Tgl</th>
                            <th class="px-4 py-3">No</th>
                            <th class="px-4 py-3">Pasien</th>
                            <th class="px-4 py-3">Dokter Pengirim</th>
                            <th class="px-4 py-3">Pemeriksaan</th>
                            <th class="px-4 py-3">Tarif</th>
                            <th class="px-4 py-3">Jasa Dokter</th>
                            <th class="px-4 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Rows rendered by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer class="text-center text-gray-400 text-xs mt-8 pb-4">
            &copy; 2025 Radiology Data System. Local Storage Enabled.
        </footer>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- DATA CONFIGURATION ---
        // Mapping pemeriksaan to tarif options and jasa options
        const pricingConfig = {
            "THORAX": {
                tarif: [122500, 130500, 145500, 153500],
                jasa: [40000, 46000, 54000, 58000]
            },
            "LUMBAL": {
                tarif: [190500, 195500, 202500, 209500],
                jasa: [66000, 70000, 74000, 76000]
            },
            "ABDOMEN 3 PSS": {
                tarif: [302500, 326500, 366000, 388500],
                jasa: [124000, 138000, 160000, 174000]
            },
            "KEPALA": {
                tarif: [150000, 216000, 259200, 311040],
                jasa: [36000, 39000, 41000, 43000]
            },
            "CERVICAL": {
                tarif: [167000, 190500, 205000, 217500],
                jasa: [66000, 80000, 88000, 96000]
            },
            "CLAVICULA": {
                tarif: [104000, 116500, 124000, 131000],
                jasa: [33000, 40000, 44000, 48000]
            },
            "SHOULDER": {
                tarif: [147500, 154500, 162500, 171500],
                jasa: [52000, 55000, 60000, 64000]
            },
            "HUMERUS": {
                tarif: [147500, 154500, 162500, 171500],
                jasa: [52000, 55000, 60000, 64000]
            },
            "ANTEBRACHI": {
                tarif: [147500, 154500, 162500, 171500],
                jasa: [52000, 55000, 60000, 64000]
            },
            "ELBOW": {
                tarif: [147500, 154500, 162500, 171500],
                jasa: [52000, 55000, 60000, 64000]
            },
            "MANUS": {
                tarif: [158500, 165500, 173500, 182500],
                jasa: [52000, 55000, 60000, 64000]
            },
            "WRIST": {
                tarif: [158500, 165500, 173500, 182500],
                jasa: [5000, 6000, 7000, 8000], // Note: Prompt said Jasa Radiografer here, treated as Jasa field
                jasaLabel: "Jasa Radiografer Wrist" 
            },
            "THORACHOLUMBAL": {
                tarif: [228000, 273600, 328320, 393984],
                jasa: [78796, 65664, 54720, 45600]
            },
            "THORACHAL": {
                tarif: [190500, 195500, 202500, 209500],
                jasa: [66000, 70000, 74000, 76000]
            },
            "PEDIS": {
                tarif: [149500, 154500, 162500, 171500],
                jasa: [50000, 55000, 60000, 64000]
            },
            "ANKLE": {
                tarif: [149500, 154500, 162500, 171500],
                jasa: [50000, 55000, 60000, 64000]
            },
            "GENU": {
                tarif: [149500, 154500, 162500, 171500],
                jasa: [50000, 55000, 60000, 64000]
            },
            "CRURIS": {
                tarif: [172500, 179500, 186500, 193500],
                jasa: [66000, 70000, 73000, 76000]
            },
            "FEMUR": {
                tarif: [172500, 179500, 186500, 193500],
                jasa: [66000, 70000, 73000, 76000]
            },
            "USG ABDOMEN": {
                tarif: [400000, 440000, 480000, 520000],
                jasa: "manual"
            },
            "USG TIROID": {
                tarif: [175000, 192000, 21000, 227500],
                jasa: "manual"
            },
            "USG MAMAE": {
                tarif: [190000, 209000, 219000, 228000],
                jasa: "manual"
            },
            "USG DOPLER EXTREMITAS": {
                tarif: [220000, 242000, 264000, 286000],
                jasa: "manual"
            },
            "USG LAIN LAIN": {
                tarif: "manual",
                jasa: "manual"
            },
            "BNO": { tarif: "manual", jasa: "manual" }, // Not specified in prompt detail, fallback to manual
            "ABDOMEN": { tarif: "manual", jasa: "manual" }, // Standard abdomen single pos?
            "PELVIS": { tarif: "manual", jasa: "manual" }
        };

        // --- INIT & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('tglPemeriksaan');
            dateInput.valueAsDate = new Date(); // Set default date to today

            populateJenisPemeriksaan();
            renderTable();
        });

        function populateJenisPemeriksaan() {
            const select = document.getElementById('jenisPemeriksaan');
            const keys = Object.keys(pricingConfig).sort();
            keys.forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                select.appendChild(opt);
            });
        }

        function updateTarifFields() {
            const jenis = document.getElementById('jenisPemeriksaan').value;
            const tarifContainer = document.getElementById('tarifContainer');
            const jasaContainer = document.getElementById('jasaDokterContainer');

            if (!jenis || !pricingConfig[jenis]) {
                tarifContainer.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">Tarif Pemeriksaan</label><input type="text" disabled class="w-full bg-gray-100 border p-2 rounded">`;
                jasaContainer.innerHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">Jasa Dokter</label><input type="text" disabled class="w-full bg-gray-100 border p-2 rounded">`;
                return;
            }

            const config = pricingConfig[jenis];

            // Render Tarif Field
            let tarifHtml = `<label class="block text-sm font-medium text-gray-700 mb-1">Tarif Pemeriksaan (${jenis})</label>`;
            if (config.tarif === "manual") {
                tarifHtml += `<input type="number" name="tarifPemeriksaan" id="tarifPemeriksaan" class="w-full border-gray-300 rounded-lg shadow-sm border p-2" placeholder="Input Manual Rp" required>`;
            } else {
                tarifHtml += `<select name="tarifPemeriksaan" id="tarifPemeriksaan" class="w-full border-gray-300 rounded-lg shadow-sm border p-2" required>`;
                config.tarif.forEach(val => {
                    tarifHtml += `<option value="${val}">Rp ${val.toLocaleString('id-ID')}</option>`;
                });
                tarifHtml += `</select>`;
            }
            tarifContainer.innerHTML = tarifHtml;

            // Render Jasa Dokter Field
            let jasaLabel = config.jasaLabel || "Jasa Dokter";
            let jasaHtml = `<label class="block text-sm font-medium text-gray-700 mb-1">${jasaLabel}</label>`;
            if (config.jasa === "manual") {
                jasaHtml += `<input type="number" name="jasaDokter" id="jasaDokter" class="w-full border-gray-300 rounded-lg shadow-sm border p-2" placeholder="Input Manual Rp" required>`;
            } else {
                jasaHtml += `<select name="jasaDokter" id="jasaDokter" class="w-full border-gray-300 rounded-lg shadow-sm border p-2" required>`;
                config.jasa.forEach(val => {
                    jasaHtml += `<option value="${val}">Rp ${val.toLocaleString('id-ID')}</option>`;
                });
                jasaHtml += `</select>`;
            }
            jasaContainer.innerHTML = jasaHtml;
        }

        // --- CRUD OPERATIONS ---

        const form = document.getElementById('radiologyForm');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            saveData();
        });

        function saveData() {
            const dataId = document.getElementById('dataId').value;
            const timestamp = dataId ? parseInt(dataId) : new Date().getTime();
            
            const newData = {
                id: timestamp,
                noManual: document.getElementById('noManual').value,
                kodePenjamin: document.getElementById('kodePenjamin').value,
                tglPemeriksaan: document.getElementById('tglPemeriksaan').value,
                namaPasien: document.getElementById('namaPasien').value,
                jenisKelamin: document.getElementById('jenisKelamin').value,
                kelas: document.getElementById('kelas').value,
                jenisDokter: document.getElementById('jenisDokter').value,
                dokterPengirim: document.getElementById('dokterPengirim').value,
                jumlahFilm: document.getElementById('jumlahFilm').value,
                pengulanganFoto: document.getElementById('pengulanganFoto').value,
                faktorEksposi: document.getElementById('faktorEksposi').value,
                radiografer: document.getElementById('radiografer').value,
                jasaRadiografer: document.getElementById('jasaRadiografer').value,
                jasaBahaya: document.getElementById('jasaBahaya').value,
                jenisPemeriksaan: document.getElementById('jenisPemeriksaan').value,
                tarifPemeriksaan: document.getElementById('tarifPemeriksaan').value,
                jasaDokter: document.getElementById('jasaDokter').value
            };

            let dataStore = JSON.parse(localStorage.getItem('radiologyData')) || [];

            if (dataId) {
                // Update existing
                const index = dataStore.findIndex(item => item.id == dataId);
                if (index !== -1) {
                    dataStore[index] = newData;
                }
            } else {
                // Add new
                dataStore.push(newData);
            }

            localStorage.setItem('radiologyData', JSON.stringify(dataStore));
            clearForm();
            renderTable();
            alert('Data berhasil disimpan!');
        }

        function renderTable() {
            const dataStore = JSON.parse(localStorage.getItem('radiologyData')) || [];
            const tbody = document.getElementById('dataTableBody');
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            tbody.innerHTML = '';

            // Filter and Sort (Newest first)
            const filteredData = dataStore.filter(item => 
                item.namaPasien.toLowerCase().includes(searchInput)
            ).sort((a, b) => b.id - a.id);

            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3">${item.tglPemeriksaan}</td>
                    <td class="px-4 py-3 font-medium">${item.noManual}</td>
                    <td class="px-4 py-3">${item.namaPasien}<br><span class="text-xs text-gray-400">${item.kodePenjamin}</span></td>
                    <td class="px-4 py-3 text-xs">${item.dokterPengirim}</td>
                    <td class="px-4 py-3 font-semibold text-teal-600">${item.jenisPemeriksaan}</td>
                    <td class="px-4 py-3">Rp${parseInt(item.tarifPemeriksaan).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3">Rp${parseInt(item.jasaDokter).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editItem(${item.id})" class="text-blue-500 hover:text-blue-700 mx-1" title="Edit">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                        <button onclick="deleteItem(${item.id})" class="text-red-500 hover:text-red-700 mx-1" title="Hapus">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteItem(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data pasien ini?')) {
                let dataStore = JSON.parse(localStorage.getItem('radiologyData')) || [];
                dataStore = dataStore.filter(item => item.id != id);
                localStorage.setItem('radiologyData', JSON.stringify(dataStore));
                renderTable();
            }
        }

        function editItem(id) {
            const dataStore = JSON.parse(localStorage.getItem('radiologyData')) || [];
            const item = dataStore.find(i => i.id == id);

            if (item) {
                document.getElementById('dataId').value = item.id;
                document.getElementById('noManual').value = item.noManual;
                document.getElementById('kodePenjamin').value = item.kodePenjamin;
                document.getElementById('tglPemeriksaan').value = item.tglPemeriksaan;
                document.getElementById('namaPasien').value = item.namaPasien;
                document.getElementById('jenisKelamin').value = item.jenisKelamin;
                document.getElementById('kelas').value = item.kelas;
                document.getElementById('jenisDokter').value = item.jenisDokter;
                document.getElementById('dokterPengirim').value = item.dokterPengirim;
                document.getElementById('jumlahFilm').value = item.jumlahFilm;
                document.getElementById('pengulanganFoto').value = item.pengulanganFoto;
                document.getElementById('faktorEksposi').value = item.faktorEksposi;
                document.getElementById('radiografer').value = item.radiografer;
                document.getElementById('jasaRadiografer').value = item.jasaRadiografer;
                document.getElementById('jasaBahaya').value = item.jasaBahaya;
                
                // Trigger change to populate dynamic fields
                document.getElementById('jenisPemeriksaan').value = item.jenisPemeriksaan;
                updateTarifFields();

                // Wait a tick for DOM update then set values
                setTimeout(() => {
                    document.getElementById('tarifPemeriksaan').value = item.tarifPemeriksaan;
                    document.getElementById('jasaDokter').value = item.jasaDokter;
                }, 50);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function clearForm() {
            document.getElementById('radiologyForm').reset();
            document.getElementById('dataId').value = '';
            document.getElementById('tglPemeriksaan').valueAsDate = new Date();
            updateTarifFields(); // Reset dynamic fields
        }

        // --- ADMIN FEATURES ---

        function deleteAllData() {
            const password = prompt("Masukkan Kata Sandi untuk Menghapus SEMUA Data:");
            if (password === "123456") {
                if (confirm("PERINGATAN: Semua data akan hilang permanen. Lanjutkan?")) {
                    localStorage.removeItem('radiologyData');
                    renderTable();
                    alert("Semua data telah dihapus.");
                }
            } else if (password !== null) {
                alert("Kata sandi salah!");
            }
        }

        function downloadExcel() {
            const dataStore = JSON.parse(localStorage.getItem('radiologyData')) || [];
            if (dataStore.length === 0) {
                alert("Tidak ada data untuk diunduh.");
                return;
            }

            // Define Headers
            const headers = [
                "ID", "No Manual", "Kode Penjamin", "Tgl Pemeriksaan", "Nama Pasien", 
                "JK", "Kelas", "Jenis Dokter", "Dokter Pengirim", 
                "Jml Film", "Pengulangan", "Faktor Eksposi", "Radiografer", 
                "Jasa Radiografer", "Jasa Bahaya", "Jenis Pemeriksaan", "Tarif", "Jasa Dokter"
            ];

            // Convert to CSV format
            const csvRows = [];
            csvRows.push(headers.join(","));

            dataStore.forEach(row => {
                const values = [
                    row.id,
                    `"${row.noManual}"`,
                    row.kodePenjamin,
                    row.tglPemeriksaan,
                    `"${row.namaPasien}"`,
                    row.jenisKelamin,
                    row.kelas,
                    row.jenisDokter,
                    `"${row.dokterPengirim}"`,
                    row.jumlahFilm,
                    row.pengulanganFoto,
                    `"${row.faktorEksposi}"`,
                    `"${row.radiografer}"`,
                    row.jasaRadiografer,
                    row.jasaBahaya,
                    `"${row.jenisPemeriksaan}"`,
                    row.tarifPemeriksaan,
                    row.jasaDokter
                ];
                csvRows.push(values.join(","));
            });

            const csvString = csvRows.join("\n");
            const blob = new Blob([csvString], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.setAttribute("hidden", "");
            a.setAttribute("href", url);
            a.setAttribute("download", `laporan_radiologi_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
